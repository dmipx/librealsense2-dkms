From 2ca188d5998bd7f49c9c65c3873e32e4a1fb6a79 Mon Sep 17 00:00:00 2001
From: Dmitry Perchanov <dmitry.perchanov@intel.com>
Date: Wed, 12 Oct 2022 17:35:10 +0300
Subject: [PATCH] Adjust Makefiles for the kernel modules to be build as part
 of DKMS focal hwe-5.11

Signed-off-by: Dmitry Perchanov <dmitry.perchanov@intel.com>
---
 5.11.0/drivers/media/usb/uvc/Makefile     | 5 +++++
 5.11.0/drivers/media/usb/uvc/uvcvideo.h   | 7 ++++++-
 5.11.0/drivers/media/v4l2-core/Makefile   | 2 ++
 5.11.0/drivers/media/v4l2-core/v4l2-dev.c | 1 +
 4 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/5.11.0/drivers/media/usb/uvc/Makefile b/5.11.0/drivers/media/usb/uvc/Makefile
index 4f9eee4..ec9da55 100644
--- a/5.11.0/drivers/media/usb/uvc/Makefile
+++ b/5.11.0/drivers/media/usb/uvc/Makefile
@@ -5,3 +5,8 @@ ifeq ($(CONFIG_MEDIA_CONTROLLER),y)
 uvcvideo-objs  += uvc_entity.o
 endif
 obj-$(CONFIG_USB_VIDEO_CLASS) += uvcvideo.o
+
+#Librealsense-dkms addition
+CONFIG_MODULE_SIG=n
+CC := ${CC} -I ${M}/../../../../include-overrides
+ccflags-y := -DDRIVER_VERSION_SUFFIX=\"${DRIVER_VERSION_SUFFIX}\"
diff --git a/5.11.0/drivers/media/usb/uvc/uvcvideo.h b/5.11.0/drivers/media/usb/uvc/uvcvideo.h
index 30dd27a..b979518 100644
--- a/5.11.0/drivers/media/usb/uvc/uvcvideo.h
+++ b/5.11.0/drivers/media/usb/uvc/uvcvideo.h
@@ -208,7 +208,12 @@
  * Driver specific constants.
  */
 
-#define DRIVER_VERSION		"1.1.1"
+/* Librealsense dkms amendments*/
+#ifndef DRIVER_VERSION_SUFFIX
+#define DRIVER_VERSION_SUFFIX
+#endif
+
+#define DRIVER_VERSION		"1.1.2" DRIVER_VERSION_SUFFIX
 
 /* Number of isochronous URBs. */
 #define UVC_URBS		5
diff --git a/5.11.0/drivers/media/v4l2-core/Makefile b/5.11.0/drivers/media/v4l2-core/Makefile
index 2ef0c7c..c0323e0 100644
--- a/5.11.0/drivers/media/v4l2-core/Makefile
+++ b/5.11.0/drivers/media/v4l2-core/Makefile
@@ -2,6 +2,8 @@
 #
 # Makefile for the V4L2 core
 #
+# Librealsense dkms appendix
+CC := ${CC} -I ${M}/../../../include-overrides -I ${M}/../tuners -I ${M}/../dvb-core -I ${M}/../dvb-frontends
 
 tuner-objs	:=	tuner-core.o
 
diff --git a/5.11.0/drivers/media/v4l2-core/v4l2-dev.c b/5.11.0/drivers/media/v4l2-core/v4l2-dev.c
index a593ea0..5c4c59a 100644
--- a/5.11.0/drivers/media/v4l2-core/v4l2-dev.c
+++ b/5.11.0/drivers/media/v4l2-core/v4l2-dev.c
@@ -1131,3 +1131,4 @@ MODULE_AUTHOR("Alan Cox, Mauro Carvalho Chehab <mchehab@kernel.org>, Bill Dirks,
 MODULE_DESCRIPTION("Video4Linux2 core driver");
 MODULE_LICENSE("GPL");
 MODULE_ALIAS_CHARDEV_MAJOR(VIDEO_MAJOR);
+MODULE_VERSION("realsense2-dkms");
-- 
2.37.1

